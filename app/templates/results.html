{% extends 'base.html' %}

{% block title %}BED File Results{% endblock %}

{% block content %}
    <style>
        #igv-div {
            height: 600px;
            width: 100%;
            margin-top: 20px;
        }
        .table-wrapper {
            max-height: 400px; /* Adjust the height as needed */
            overflow: auto;
        }
    </style>

    <h1 class="mb-4"><p></p>BED File Results</h1>
    <div class="mb-3">
        <a href="{{ url_for('bed_generator.index') }}" class="btn btn-secondary">Back to BED File Generator</a>
    </div>
    {% if results %}
        <div class="mb-3">
            <button class="btn btn-primary" onclick="downloadBED()">Download BED File</button>
            <button class="btn btn-primary" onclick="loadIGV()">View in IGV</button>
            <select id="genome-select" class="form-select d-inline-block w-auto ml-2" onchange="changeGenome()">
                <option value="hg38">hg38</option>
                <option value="hg19">hg19</option>
            </select>
        </div>
        <div class="mb-3">
            <h4>Select columns for BED file:</h4>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="chkChromosome" checked>
                <label class="form-check-label" for="chkChromosome">Chromosome</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="chkStart" checked>
                <label class="form-check-label" for="chkStart">Start</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="chkEnd" checked>
                <label class="form-check-label" for="chkEnd">End</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="chkEntrezID">
                <label class="form-check-label" for="chkEntrezID">EntrezID</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="chkGene">
                <label class="form-check-label" for="chkGene">Gene</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="chkAccession">
                <label class="form-check-label" for="chkAccession">Accession</label>
            </div>
        </div>
        <div class="mb-3 table-wrapper">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>#Chr</th>
                        <th>Start</th>
                        <th>End</th>
                        <th>EntrezID</th>
                        <th>Gene</th>
                        <th>Accession</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in results %}
                        {% if 'rsid' in result %}
                            <tr>
                                <td>{{ result.chromosome }}</td>
                                <td>{{ result.start }}</td>
                                <td>{{ result.end }}</td>
                                <td>{{ result.entrez_id }}</td>
                                <td>{{ result.gene }}</td>
                                <td>{{ result.accession }}</td>
                            </tr>
                        {% else %}
                            <tr>
                                <td>{{ result.loc_region }}</td>
                                <td>{{ result.loc_start }}</td>
                                <td>{{ result.loc_end }}</td>
                                <td>{{ result.entrez_id }}</td>
                                <td>{{ result.gene }}</td>
                                <td>{{ result.accession }}</td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div id="igv-div" style="padding-top: 10px; padding-bottom: 10px; border:1px solid lightgray"></div>
        <textarea id="bedContent" style="display: none;">{{ results | tojson }}</textarea>
    {% else %}
        <p>No results found.</p>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/igv@2.10.5/dist/igv.min.js"></script>
    <script>
        let igvBrowser;

        function loadIGV() {
            var loadingIndicator = document.createElement('div');
            loadingIndicator.id = 'igv-loading';
            loadingIndicator.innerHTML = 'Loading IGV...';
            document.getElementById('igv-div').appendChild(loadingIndicator);

            var results = JSON.parse(document.getElementById('bedContent').value);
            var bedContent = createBedContent(results);
            var genome = document.getElementById('genome-select').value;

            if (!igvBrowser) {
                var options = {
                    genome: genome,
                    tracks: [
                        {
                            name: "Generated BED",
                            url: "data:application/bed," + encodeURIComponent(bedContent),
                            format: "bed",
                            displayMode: "EXPANDED"
                        }
                    ]
                };

                igv.createBrowser(document.getElementById('igv-div'), options)
                    .then(function (browser) {
                        igvBrowser = browser;
                        document.getElementById('igv-loading').remove();
                    })
                    .catch(function(error) {
                        console.error('Error creating IGV browser:', error);
                        document.getElementById('igv-loading').innerHTML = 'Error loading IGV. Please try again.';
                    });
            } else {
                igvBrowser.loadTrack({
                    name: "Generated BED",
                    url: "data:application/bed," + encodeURIComponent(bedContent),
                    format: "bed",
                    displayMode: "EXPANDED"
                });
                document.getElementById('igv-loading').remove();
            }
        }

        function changeGenome() {
            var genome = document.getElementById('genome-select').value;
            if (igvBrowser) {
                igvBrowser.loadGenome(genome);
            }
        }

        function createBedContent(results) {
            var content = '';
            var selectedColumns = getSelectedColumns();
            for (var i = 0; i < results.length; i++) {
                var result = results[i];
                var line = [];
                if (selectedColumns.includes('chromosome')) {
                    line.push('rsid' in result ? result.chromosome : result.loc_region);
                }
                if (selectedColumns.includes('start')) {
                    line.push('rsid' in result ? result.start : result.loc_start);
                }
                if (selectedColumns.includes('end')) {
                    line.push('rsid' in result ? result.end : result.loc_end);
                }
                if (selectedColumns.includes('entrezID')) {
                    line.push(result.entrez_id);
                }
                if (selectedColumns.includes('gene')) {
                    line.push(result.gene);
                }
                if (selectedColumns.includes('accession')) {
                    line.push(result.accession);
                }
                content += line.join('\t') + '\n';
            }
            return content;
        }

        function getSelectedColumns() {
            var columns = [];
            if (document.getElementById('chkChromosome').checked) columns.push('chromosome');
            if (document.getElementById('chkStart').checked) columns.push('start');
            if (document.getElementById('chkEnd').checked) columns.push('end');
            if (document.getElementById('chkEntrezID').checked) columns.push('entrezID');
            if (document.getElementById('chkGene').checked) columns.push('gene');
            if (document.getElementById('chkAccession').checked) columns.push('accession');
            return columns;
        }

        function downloadBED() {
            var results = JSON.parse(document.getElementById('bedContent').value);
            var content = createBedContent(results);
            var filename = 'output.bed';
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }
    </script>
{% endblock %}